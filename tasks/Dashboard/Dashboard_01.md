# Task 04: Dashboard Stock Portfolio Table

## Objective

Update the dashboard page to display a stock portfolio table showing the user's holdings with real-time pricing information. All price retrieval and return calculations are performed on the backend API.

---

## Architecture Overview

```
┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│    Frontend     │ ──API── │    Backend      │ ──HTTP──│  Yahoo Finance  │
│   React + TS    │         │  Spring Boot    │         │   (Free API)    │
└─────────────────┘         └─────────────────┘         └─────────────────┘
                                    │
                                    │ JPA
                                    ▼
                            ┌─────────────────┐
                            │    Database     │
                            │   (Holdings)    │
                            └─────────────────┘
```

**Key Design Decisions:**
- Price retrieval → Backend (via Yahoo Finance)
- Return calculations → Backend
- Frontend → Display only (no business logic)

---

## Table Specification

| Column | Description |
|--------|-------------|
| **Symbol** | Stock ticker symbol (e.g., AAPL, TSLA, GOOGL) |
| **Last Price** | The most recent trading price for the stock |
| **Total Return** | Personal gain/loss shown as both percentage (%) and dollar ($) amount |
| **Value/Cost** | Current market value vs. total cost basis (e.g., $5,240 / $4,800) |

---

## Yahoo Finance Integration

### Why Yahoo Finance?

Yahoo Finance provides free stock data through unofficial but widely-used endpoints. No API key required.

### Available Endpoints

| Endpoint | Purpose | Rate Limit |
|----------|---------|------------|
| `query1.finance.yahoo.com/v8/finance/chart/{symbol}` | Historical + current price | ~2000/hour |
| `query1.finance.yahoo.com/v7/finance/quote?symbols=X,Y,Z` | Batch quotes (up to 10) | ~2000/hour |

### Recommended Endpoint for This Feature

**Batch Quote Endpoint** (preferred for portfolio view):
```
GET https://query1.finance.yahoo.com/v7/finance/quote?symbols=AAPL,MSFT,GOOGL
```

Response structure (simplified):
```json
{
  "quoteResponse": {
    "result": [
      {
        "symbol": "AAPL",
        "regularMarketPrice": 178.25,
        "regularMarketPreviousClose": 176.50,
        "shortName": "Apple Inc.",
        "regularMarketChange": 1.75,
        "regularMarketChangePercent": 0.99
      }
    ]
  }
}
```

### Caching Strategy

To avoid rate limiting and improve performance:
- Cache prices for 1-5 minutes (configurable)
- Use Spring's `@Cacheable` with Caffeine cache
- Batch requests when fetching multiple symbols

---

## Implementation Phases

### Phase 1: Backend - Configuration

**File**: `backend/src/main/resources/application.yml`

Add Yahoo Finance configuration:

```yaml
# Yahoo Finance API Configuration
yahoo:
  finance:
    quote-url: https://query1.finance.yahoo.com/v7/finance/quote
```

---

### Phase 2: Backend - Database Entity

**File**: `backend/src/main/java/com/stocktracker/entity/Holding.java`

```java
@Entity
@Table(name = "holdings")
@Getter @Setter @NoArgsConstructor @AllArgsConstructor @Builder
public class Holding extends BaseEntity {
    // Note: id (Long, auto-increment), createdAt, updatedAt inherited from BaseEntity

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    @Column(nullable = false, length = 10)
    private String symbol;           // e.g., "AAPL"

    @Column(nullable = false, length = 100)
    private String companyName;      // e.g., "Apple Inc."

    @Column(nullable = false, precision = 12, scale = 4)
    private BigDecimal shares;       // Supports fractional shares

    @Column(nullable = false, precision = 10, scale = 2)
    private BigDecimal averageCost;  // Cost per share
}
```

**Database Schema** (auto-generated by JPA):

```sql
CREATE TABLE holdings (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    symbol VARCHAR(10) NOT NULL,
    company_name VARCHAR(100) NOT NULL,
    shares DECIMAL(12,4) NOT NULL,
    average_cost DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

**File**: `backend/src/main/java/com/stocktracker/repository/HoldingRepository.java`

```java
@Repository
public interface HoldingRepository extends JpaRepository<Holding, Long> {
    List<Holding> findByUserIdOrderBySymbolAsc(Long userId);
    Optional<Holding> findByUserIdAndSymbol(Long userId, String symbol);
    boolean existsByUserIdAndSymbol(Long userId, String symbol);
}
```

---

### Phase 3: Backend - Yahoo Finance Client

**File**: `backend/src/main/java/com/stocktracker/client/YahooFinanceClient.java`

```java
@Component
@Slf4j
public class YahooFinanceClient {

    private final String quoteUrl;
    private final RestTemplate restTemplate;

    public YahooFinanceClient(
            @Value("${yahoo.finance.quote-url}") String quoteUrl,
            RestTemplateBuilder builder) {
        this.quoteUrl = quoteUrl;
        this.restTemplate = builder
            .setConnectTimeout(Duration.ofSeconds(5))
            .setReadTimeout(Duration.ofSeconds(10))
            .build();
    }

    /**
     * Fetch quotes for multiple symbols in a single request.
     * @param symbols List of stock symbols (max 10 per request)
     * @return Map of symbol to quote data
     */
    public Map<String, StockQuote> getQuotes(List<String> symbols) {
        if (symbols == null || symbols.isEmpty()) {
            return Collections.emptyMap();
        }

        try {
            String symbolsParam = String.join(",", symbols);
            String url = quoteUrl + "?symbols=" + symbolsParam;

            log.debug("Fetching quotes for symbols: {}", symbolsParam);
            // Implementation details...

        } catch (Exception e) {
            log.error("Failed to fetch quotes from Yahoo Finance", e);
            return Collections.emptyMap();
        }
    }
}
```

**File**: `backend/src/main/java/com/stocktracker/client/dto/StockQuote.java`

```java
@Data @Builder
public class StockQuote {
    private String symbol;
    private String shortName;
    private BigDecimal regularMarketPrice;
    private BigDecimal regularMarketPreviousClose;
    private BigDecimal regularMarketChange;
    private BigDecimal regularMarketChangePercent;
}
```

---

### Phase 4: Backend - DTOs

**File**: `backend/src/main/java/com/stocktracker/dto/response/HoldingResponse.java`

```java
@Data @Builder
public class HoldingResponse {
    private Long id;
    private String symbol;
    private String companyName;
    private BigDecimal shares;
    private BigDecimal averageCost;

    // Live price data (from Yahoo Finance)
    private BigDecimal lastPrice;
    private BigDecimal previousClose;

    // Calculated fields (computed on backend)
    private BigDecimal totalReturnDollars;    // (lastPrice - avgCost) * shares
    private BigDecimal totalReturnPercent;    // ((lastPrice - avgCost) / avgCost) * 100
    private BigDecimal currentValue;          // lastPrice * shares
    private BigDecimal costBasis;             // avgCost * shares
}
```

**File**: `backend/src/main/java/com/stocktracker/dto/response/PortfolioResponse.java`

```java
@Data @Builder
public class PortfolioResponse {
    private List<HoldingResponse> holdings;

    // Portfolio summary (computed on backend)
    private BigDecimal totalValue;
    private BigDecimal totalCost;
    private BigDecimal totalReturnDollars;
    private BigDecimal totalReturnPercent;

    private LocalDateTime pricesUpdatedAt;
}
```

---

### Phase 5: Backend - Service Layer

**File**: `backend/src/main/java/com/stocktracker/service/PortfolioService.java`

```java
@Service
@RequiredArgsConstructor
@Slf4j
public class PortfolioService {

    private final HoldingRepository holdingRepository;
    private final YahooFinanceClient yahooFinanceClient;

    /**
     * Get user's portfolio with live prices and calculated returns.
     */
    @Cacheable(value = "portfolio", key = "#userId", unless = "#result == null")
    public PortfolioResponse getPortfolio(Long userId) {
        // 1. Fetch holdings from database
        List<Holding> holdings = holdingRepository.findByUserIdOrderBySymbolAsc(userId);

        if (holdings.isEmpty()) {
            return PortfolioResponse.builder()
                .holdings(Collections.emptyList())
                .totalValue(BigDecimal.ZERO)
                .totalCost(BigDecimal.ZERO)
                .totalReturnDollars(BigDecimal.ZERO)
                .totalReturnPercent(BigDecimal.ZERO)
                .pricesUpdatedAt(LocalDateTime.now())
                .build();
        }

        // 2. Fetch live prices from Yahoo Finance
        List<String> symbols = holdings.stream()
            .map(Holding::getSymbol)
            .collect(Collectors.toList());
        Map<String, StockQuote> quotes = yahooFinanceClient.getQuotes(symbols);

        // 3. Calculate returns for each holding
        List<HoldingResponse> holdingResponses = holdings.stream()
            .map(h -> buildHoldingResponse(h, quotes.get(h.getSymbol())))
            .collect(Collectors.toList());

        // 4. Calculate portfolio totals
        return buildPortfolioResponse(holdingResponses);
    }

    private HoldingResponse buildHoldingResponse(Holding holding, StockQuote quote) {
        BigDecimal lastPrice = quote != null ? quote.getRegularMarketPrice() : BigDecimal.ZERO;
        BigDecimal shares = holding.getShares();
        BigDecimal avgCost = holding.getAverageCost();

        BigDecimal currentValue = lastPrice.multiply(shares);
        BigDecimal costBasis = avgCost.multiply(shares);
        BigDecimal returnDollars = currentValue.subtract(costBasis);
        BigDecimal returnPercent = avgCost.compareTo(BigDecimal.ZERO) > 0
            ? returnDollars.divide(costBasis, 4, RoundingMode.HALF_UP)
                .multiply(new BigDecimal("100"))
            : BigDecimal.ZERO;

        return HoldingResponse.builder()
            .id(holding.getId())
            .symbol(holding.getSymbol())
            .companyName(holding.getCompanyName())
            .shares(shares)
            .averageCost(avgCost)
            .lastPrice(lastPrice)
            .previousClose(quote != null ? quote.getRegularMarketPreviousClose() : null)
            .currentValue(currentValue)
            .costBasis(costBasis)
            .totalReturnDollars(returnDollars)
            .totalReturnPercent(returnPercent)
            .build();
    }

    private PortfolioResponse buildPortfolioResponse(List<HoldingResponse> holdings) {
        BigDecimal totalValue = holdings.stream()
            .map(HoldingResponse::getCurrentValue)
            .reduce(BigDecimal.ZERO, BigDecimal::add);
        BigDecimal totalCost = holdings.stream()
            .map(HoldingResponse::getCostBasis)
            .reduce(BigDecimal.ZERO, BigDecimal::add);
        BigDecimal totalReturnDollars = totalValue.subtract(totalCost);
        BigDecimal totalReturnPercent = totalCost.compareTo(BigDecimal.ZERO) > 0
            ? totalReturnDollars.divide(totalCost, 4, RoundingMode.HALF_UP)
                .multiply(new BigDecimal("100"))
            : BigDecimal.ZERO;

        return PortfolioResponse.builder()
            .holdings(holdings)
            .totalValue(totalValue)
            .totalCost(totalCost)
            .totalReturnDollars(totalReturnDollars)
            .totalReturnPercent(totalReturnPercent)
            .pricesUpdatedAt(LocalDateTime.now())
            .build();
    }
}
```

---

### Phase 6: Backend - Controller

**File**: `backend/src/main/java/com/stocktracker/controller/PortfolioController.java`

```java
@RestController
@RequestMapping("/api/portfolio")
@RequiredArgsConstructor
@Tag(name = "Portfolio", description = "Portfolio management endpoints")
public class PortfolioController {

    private final PortfolioService portfolioService;

    @GetMapping
    @Operation(summary = "Get user's portfolio with live prices")
    public ResponseEntity<ApiResponse<PortfolioResponse>> getPortfolio(
            @AuthenticationPrincipal UserDetails userDetails) {
        Long userId = ((CustomUserDetails) userDetails).getId();
        PortfolioResponse portfolio = portfolioService.getPortfolio(userId);
        return ResponseEntity.ok(ApiResponse.success(portfolio));
    }

    @GetMapping("/refresh")
    @Operation(summary = "Force refresh prices (bypasses cache)")
    @CacheEvict(value = "portfolio", key = "#userDetails.id")
    public ResponseEntity<ApiResponse<PortfolioResponse>> refreshPortfolio(
            @AuthenticationPrincipal UserDetails userDetails) {
        Long userId = ((CustomUserDetails) userDetails).getId();
        PortfolioResponse portfolio = portfolioService.getPortfolio(userId);
        return ResponseEntity.ok(ApiResponse.success(portfolio));
    }
}
```

---

### Phase 7: Backend - Caching Configuration

**File**: `backend/src/main/java/com/stocktracker/config/CacheConfig.java`

```java
@Configuration
@EnableCaching
public class CacheConfig {

    @Bean
    public CacheManager cacheManager() {
        CaffeineCacheManager cacheManager = new CaffeineCacheManager();
        cacheManager.setCaffeine(Caffeine.newBuilder()
            .expireAfterWrite(Duration.ofMinutes(2))  // Cache prices for 2 minutes
            .maximumSize(1000));
        return cacheManager;
    }
}
```

**Add to pom.xml:**
```xml
<dependency>
    <groupId>com.github.ben-manes.caffeine</groupId>
    <artifactId>caffeine</artifactId>
</dependency>
```

---

### Phase 8: Backend - Seed Data

**File**: `backend/src/main/resources/data.sql` (append)

```sql
-- Sample holdings for demo user (id = 1)
-- Note: id column auto-increments, so we don't specify it
INSERT INTO holdings (user_id, symbol, company_name, shares, average_cost, created_at, updated_at)
VALUES
    (1, 'AAPL', 'Apple Inc.', 50.0000, 142.50, NOW(), NOW()),
    (1, 'MSFT', 'Microsoft Corporation', 25.0000, 285.00, NOW(), NOW()),
    (1, 'GOOGL', 'Alphabet Inc.', 10.0000, 125.30, NOW(), NOW()),
    (1, 'TSLA', 'Tesla, Inc.', 15.0000, 248.00, NOW(), NOW()),
    (1, 'NVDA', 'NVIDIA Corporation', 20.0000, 450.00, NOW(), NOW()),
    (1, 'AMZN', 'Amazon.com, Inc.', 30.0000, 135.00, NOW(), NOW());
```

---

### Phase 9: Frontend - API Client

**File**: `frontend/src/api/portfolioApi.ts`

```typescript
import { apiClient } from './client';

export interface HoldingResponse {
  id: number;
  symbol: string;
  companyName: string;
  shares: number;
  averageCost: number;
  lastPrice: number;
  previousClose: number | null;
  totalReturnDollars: number;
  totalReturnPercent: number;
  currentValue: number;
  costBasis: number;
}

export interface PortfolioResponse {
  holdings: HoldingResponse[];
  totalValue: number;
  totalCost: number;
  totalReturnDollars: number;
  totalReturnPercent: number;
  pricesUpdatedAt: string;
}

export const portfolioApi = {
  getPortfolio: async (): Promise<PortfolioResponse> => {
    const response = await apiClient.get('/api/portfolio');
    return response.data.data;
  },

  refreshPortfolio: async (): Promise<PortfolioResponse> => {
    const response = await apiClient.get('/api/portfolio/refresh');
    return response.data.data;
  }
};
```

---

### Phase 10: Frontend - Types (Simplified)

**File**: `frontend/src/types/stock.ts`

```typescript
// Re-export from API for convenience
export type { HoldingResponse, PortfolioResponse } from '../api/portfolioApi';

// UI-specific type for display formatting
export interface StockTableRow {
  id: number;
  symbol: string;
  companyName: string;
  lastPrice: number;
  totalReturnDollars: number;
  totalReturnPercent: number;
  currentValue: number;
  costBasis: number;
}
```

---

### Phase 11: Frontend - Utility Functions (Display Only)

**File**: `frontend/src/utils/stockFormatters.ts`

```typescript
// Format currency with proper symbols and decimals
export function formatCurrency(value: number): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(value);
}

// Format percentage with sign indicator
export function formatPercent(value: number): string {
  const sign = value >= 0 ? '+' : '';
  return `${sign}${value.toFixed(2)}%`;
}

// Get CSS class for positive/negative returns
export function getReturnColorClass(value: number): string {
  if (value > 0) return 'text-emerald-600';
  if (value < 0) return 'text-red-500';
  return 'text-slate-600';
}
```

---

### Phase 12: Frontend - Portfolio Hook

**File**: `frontend/src/hooks/usePortfolio.ts`

```typescript
import { useState, useEffect, useCallback } from 'react';
import { portfolioApi, PortfolioResponse } from '../api/portfolioApi';

export function usePortfolio() {
  const [portfolio, setPortfolio] = useState<PortfolioResponse | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const fetchPortfolio = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const data = await portfolioApi.getPortfolio();
      setPortfolio(data);
    } catch (err) {
      setError('Failed to load portfolio');
    } finally {
      setLoading(false);
    }
  }, []);

  const refresh = useCallback(async () => {
    try {
      setError(null);
      const data = await portfolioApi.refreshPortfolio();
      setPortfolio(data);
    } catch (err) {
      setError('Failed to refresh prices');
    }
  }, []);

  useEffect(() => {
    fetchPortfolio();
  }, [fetchPortfolio]);

  return { portfolio, loading, error, refresh };
}
```

---

### Phase 13: Frontend - Dashboard Components

#### 13.1 Portfolio Table Component

**File**: `frontend/src/components/dashboard/PortfolioTable.tsx`

```typescript
import { HoldingResponse } from '../../api/portfolioApi';
import { PortfolioTableRow } from './PortfolioTableRow';

interface PortfolioTableProps {
  holdings: HoldingResponse[];
}

export function PortfolioTable({ holdings }: PortfolioTableProps) {
  return (
    <div className="overflow-x-auto rounded-xl border border-border bg-white shadow-soft">
      <table className="w-full">
        <thead className="bg-slate-50">
          <tr>
            <th className="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wide text-slate-600">
              Symbol
            </th>
            <th className="px-6 py-4 text-right text-sm font-semibold uppercase tracking-wide text-slate-600">
              Last Price
            </th>
            <th className="px-6 py-4 text-right text-sm font-semibold uppercase tracking-wide text-slate-600">
              Total Return
            </th>
            <th className="px-6 py-4 text-right text-sm font-semibold uppercase tracking-wide text-slate-600">
              Value / Cost
            </th>
          </tr>
        </thead>
        <tbody className="divide-y divide-slate-100">
          {holdings.map((holding) => (
            <PortfolioTableRow key={holding.id} holding={holding} />
          ))}
        </tbody>
      </table>
    </div>
  );
}
```

#### 13.2 Portfolio Table Row Component

**File**: `frontend/src/components/dashboard/PortfolioTableRow.tsx`

```typescript
import { HoldingResponse } from '../../api/portfolioApi';
import { formatCurrency, formatPercent, getReturnColorClass } from '../../utils/stockFormatters';

interface PortfolioTableRowProps {
  holding: HoldingResponse;
}

export function PortfolioTableRow({ holding }: PortfolioTableRowProps) {
  const returnClass = getReturnColorClass(holding.totalReturnDollars);

  return (
    <tr className="transition-colors hover:bg-slate-50">
      {/* Symbol Column */}
      <td className="px-6 py-4">
        <div className="font-semibold text-slate-900">{holding.symbol}</div>
        <div className="text-sm text-slate-500">{holding.companyName}</div>
      </td>

      {/* Last Price Column */}
      <td className="px-6 py-4 text-right font-medium text-slate-900">
        {formatCurrency(holding.lastPrice)}
      </td>

      {/* Total Return Column */}
      <td className={`px-6 py-4 text-right ${returnClass}`}>
        <div className="font-medium">{formatPercent(holding.totalReturnPercent)}</div>
        <div className="text-sm">{formatCurrency(holding.totalReturnDollars)}</div>
      </td>

      {/* Value/Cost Column */}
      <td className="px-6 py-4 text-right">
        <span className="font-semibold text-slate-900">
          {formatCurrency(holding.currentValue)}
        </span>
        <span className="text-slate-400"> / </span>
        <span className="text-slate-500">{formatCurrency(holding.costBasis)}</span>
      </td>
    </tr>
  );
}
```

---

### Phase 14: Frontend - Dashboard Page

**File**: `frontend/src/pages/Dashboard/Dashboard.tsx`

```typescript
import { usePortfolio } from '../../hooks/usePortfolio';
import { PortfolioTable } from '../../components/dashboard/PortfolioTable';
import { formatCurrency, formatPercent, getReturnColorClass } from '../../utils/stockFormatters';

export function Dashboard() {
  const { portfolio, loading, error, refresh } = usePortfolio();

  if (loading) {
    return <div className="flex justify-center p-8">Loading portfolio...</div>;
  }

  if (error) {
    return <div className="p-8 text-red-500">{error}</div>;
  }

  return (
    <div className="container mx-auto px-4 py-8">
      <header className="mb-8 flex items-center justify-between">
        <h1 className="text-2xl font-bold text-slate-900">Portfolio Overview</h1>
        <button
          onClick={refresh}
          className="rounded-lg bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700"
        >
          Refresh Prices
        </button>
      </header>

      {/* Portfolio Summary Card */}
      {portfolio && (
        <div className="mb-8 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
          <SummaryCard label="Total Value" value={formatCurrency(portfolio.totalValue)} />
          <SummaryCard label="Total Cost" value={formatCurrency(portfolio.totalCost)} />
          <SummaryCard
            label="Total Return"
            value={formatCurrency(portfolio.totalReturnDollars)}
            className={getReturnColorClass(portfolio.totalReturnDollars)}
          />
          <SummaryCard
            label="Return %"
            value={formatPercent(portfolio.totalReturnPercent)}
            className={getReturnColorClass(portfolio.totalReturnPercent)}
          />
        </div>
      )}

      {/* Holdings Table */}
      <section>
        <div className="mb-4 flex items-center justify-between">
          <h2 className="text-lg font-semibold text-slate-900">Your Holdings</h2>
          <span className="text-sm text-slate-500">
            Prices updated: {portfolio?.pricesUpdatedAt ? new Date(portfolio.pricesUpdatedAt).toLocaleTimeString() : '-'}
          </span>
        </div>
        {portfolio?.holdings.length ? (
          <PortfolioTable holdings={portfolio.holdings} />
        ) : (
          <p className="text-slate-500">No holdings yet.</p>
        )}
      </section>
    </div>
  );
}
```

---

## API Specification

### Endpoints

| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| GET | `/api/portfolio` | Get user's portfolio with live prices | Yes |
| GET | `/api/portfolio/refresh` | Force refresh (bypasses cache) | Yes |

### Response Format

```json
{
  "success": true,
  "data": {
    "holdings": [
      {
        "id": 1,
        "symbol": "AAPL",
        "companyName": "Apple Inc.",
        "shares": 50.0,
        "averageCost": 142.50,
        "lastPrice": 178.25,
        "previousClose": 176.50,
        "totalReturnDollars": 1787.50,
        "totalReturnPercent": 25.08,
        "currentValue": 8912.50,
        "costBasis": 7125.00
      }
    ],
    "totalValue": 45678.90,
    "totalCost": 38500.00,
    "totalReturnDollars": 7178.90,
    "totalReturnPercent": 18.65,
    "pricesUpdatedAt": "2024-01-15T10:30:00"
  }
}
```

---

## File Structure Summary

```
backend/
├── src/main/
│   ├── java/com/stocktracker/
│   │   ├── entity/
│   │   │   └── Holding.java                    # NEW: Holdings entity (with auto-increment ID)
│   │   ├── repository/
│   │   │   └── HoldingRepository.java          # NEW: Holdings repository
│   │   ├── client/
│   │   │   ├── YahooFinanceClient.java         # NEW: Yahoo Finance API client
│   │   │   └── dto/
│   │   │       └── StockQuote.java             # NEW: Yahoo response DTO
│   │   ├── dto/
│   │   │   └── response/
│   │   │       ├── HoldingResponse.java        # NEW: Holding with calculations
│   │   │       └── PortfolioResponse.java      # NEW: Full portfolio response
│   │   ├── service/
│   │   │   └── PortfolioService.java           # NEW: Portfolio business logic
│   │   ├── controller/
│   │   │   └── PortfolioController.java        # NEW: Portfolio endpoints
│   │   └── config/
│   │       └── CacheConfig.java                # NEW: Caffeine cache setup
│   └── resources/
│       ├── application.yml                     # UPDATE: Add yahoo.finance.quote-url
│       └── data.sql                            # UPDATE: Add holdings seed data
└── pom.xml                                     # UPDATE: Add Caffeine dependency

frontend/src/
├── api/
│   └── portfolioApi.ts                 # NEW: API client
├── types/
│   └── stock.ts                        # UPDATE: Simplified types
├── utils/
│   └── stockFormatters.ts              # NEW: Display formatters only
├── hooks/
│   └── usePortfolio.ts                 # NEW: Portfolio data hook
├── components/
│   └── dashboard/
│       ├── index.ts                    # NEW: Barrel export
│       ├── PortfolioTable.tsx          # NEW: Main table component
│       └── PortfolioTableRow.tsx       # NEW: Table row component
└── pages/
    └── Dashboard/
        └── Dashboard.tsx               # UPDATE: Integrate with API
```

---

## Implementation Order

### Backend (do first)
1. Add Yahoo Finance configuration to `application.yml`
2. Add Caffeine dependency to `pom.xml`
3. Create `Holding` entity
4. Create `HoldingRepository`
5. Create `StockQuote` DTO
6. Create `YahooFinanceClient` (with @Value injection)
7. Create `HoldingResponse` and `PortfolioResponse` DTOs
8. Create `PortfolioService`
9. Create `CacheConfig`
10. Create `PortfolioController`
11. Add seed data to `data.sql`
12. Test API with Postman/curl

### Frontend (after backend works)
13. Create `portfolioApi.ts`
14. Update `types/stock.ts`
15. Create `utils/stockFormatters.ts`
16. Create `hooks/usePortfolio.ts`
17. Build `PortfolioTableRow` component
18. Build `PortfolioTable` component
19. Update `Dashboard` page
20. Test end-to-end

---

## Error Handling

### Backend
- Yahoo Finance timeout → Return cached data or zeros
- Yahoo Finance rate limit → Exponential backoff + return cached data
- Invalid symbol → Log warning, skip symbol in response
- Database error → Return 500 with generic message

### Frontend
- Network error → Show retry button
- Empty portfolio → Show "No holdings" message
- Stale prices → Show "Last updated" timestamp

---

## Design Considerations

### Responsive Behavior
- Desktop: Full table with all columns visible
- Tablet: Slight padding reduction
- Mobile: Horizontal scroll with sticky first column (symbol)

### Accessibility
- Proper semantic table markup (`<table>`, `<thead>`, `<tbody>`)
- Screen reader labels for return values (e.g., "gain" or "loss")
- Sufficient color contrast (especially for red/green values)
- Focus states for interactive elements

### Performance
- Backend caching (2-minute TTL) reduces Yahoo Finance calls
- Batch symbol requests (up to 10 per call)
- Frontend: React Query or SWR for client-side caching (future)

---

## Future Enhancements (Out of Scope)

- [ ] Sortable columns (by symbol, return %, value)
- [ ] Search/filter holdings
- [ ] Add/Edit/Delete holdings (CRUD)
- [ ] Real-time price updates via WebSocket
- [ ] Pagination for large portfolios
- [ ] Export to CSV functionality
- [ ] Price charts per holding
- [ ] Market hours indicator
- [ ] Alternative data providers (Alpha Vantage, Polygon.io)

---

## Acceptance Criteria

- [ ] Backend serves portfolio data via `/api/portfolio`
- [ ] Backend fetches live prices from Yahoo Finance
- [ ] All return calculations are done on the backend
- [ ] Prices are cached for 2 minutes
- [ ] Dashboard displays portfolio table with 4 columns
- [ ] Positive returns display in green (emerald-600)
- [ ] Negative returns display in red
- [ ] Table follows "Corporate Trust" design system
- [ ] Responsive on mobile devices
- [ ] Total Return shows both % and $ values
- [ ] Value/Cost shows both values with clear distinction
- [ ] "Refresh Prices" button bypasses cache
- [ ] Last updated timestamp is displayed
